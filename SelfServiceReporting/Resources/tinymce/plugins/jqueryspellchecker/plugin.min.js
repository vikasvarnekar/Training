/*
 * jQuery Spellchecker - TinyMCE Plugin - v0.2.4
 * https://github.com/badsyntax/jquery-spellchecker
 * Copyright (c) 2012 Richard Willis; Licensed MIT
 */

tinymce.PluginManager.add('jqueryspellchecker', function(editor, url) {

  editor.addButton('jqueryspellchecker', {
    image: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAHtSURBVDjLY/j//z8DJZiBKgY49drM9J3idhLEtu+xjvea4nLNqsVspnWr2S6QmF6+Zol2ltpq5QSlmcpxijMxDABp9pjkuMuu28rIpsMi3rLZFKzIus38mm6OuqRxpf41nC5w7rOJd+i1ngnUXGLTbj7Tsskk3rbL8ppZreEu7Ry1mWpJSvHK8Uoz0TWK5U/nYIg8y8rgPsl+l12P1WqgbTPdJtk/AtoWb1CkBdagnqyyWilawVM/Rw/FBQyx540ZGm/eYIg8P43BdYLdSZiEcYXeTJB/TaoNroH8q5OldVIhXE5SKUqhXSNRfZdKvPKVkOrED+L9d/8wN998w+B4XIL40I48K8FQf/O6+7In/7mbb35hsD2qjBKNDLU3ExjKb7pi1Rx61ke89+6fwBVP/jPXXn/HYHlYGiMdMJTe1JJc/PgHQ/X1xQyplznBYuFnmRiiz062nPfof8DSJ/8ZSq8/ZzA9KIEzIQE1Vvuuf/6fufv2M4bgsz4MxVdPui8Cal4C1Jx/+RGDPqpmTANiz7MAvXI+bO2L/5ZzHvzP2Pjif8DCx/8ZMi/fY9DcL0FUUmbwPKkg3Hr7T+WOV//95j/8z5B6/jaD6l4JkvIC0J9FTtPu/2dIPn+PQXG3BFmZiUFzbweDLH7NVMmNAOGld33BRiNUAAAAAElFTkSuQmCC',
    tooltip: fdtSpellcheckTooltip,
    onclick: function() { _onCheck(this); }
  });

  window.editor = editor;

  _onCheck = function(button) {
    var t = this;
    if (!t.spellchecker) {
      t.createSpellchecker(button);
      t.spellchecker.check();
      t.disableEditor();
      if (button) {
        button.disabled(false);
        button.active(true);
      }
    } else {
      t.spellchecker.destroy();
      t.spellchecker = null;
      t.enableEditor();
      if (button) {
        button.disabled(false);
        button.active(false);
      }
    }
  }

  toggleEditor = function(disabled, editable) {
    this.editor.theme.panel.find('toolbar *').disabled(disabled);
    this.editor.theme.panel.find('menubar *').disabled(disabled);
    this.editor.getBody().setAttribute('contenteditable', editable);
  }

  disableEditor = function() {
    this.toggleEditor(true, false);
  }

  enableEditor = function() {
    this.toggleEditor(false, true);
  }

  createSpellchecker = function(button) {
    var t = this;

    t.spellchecker = new jq$.SpellChecker(t.editor.getBody(), {
      lang: 'en',
      parser: 'html',
      webservice: {
        path: "rs.aspx",
        driver: 'pspell'
      },
      suggestBox: {
        position: 'below',
        appendTo: 'body',
        position: this.positionSuggestBox()
      },
      getText: function() {
        return t.editor.getContent();
      }
    });

    t.spellchecker.on('check.success', function() {
      tinyMCE.activeEditor.windowManager.alert(fdtNoIncorrectWords);
      t._onCheck(button);
    });
    t.spellchecker.on('check.start', function() {
      t.editor.setProgressState(1);
    });
    t.spellchecker.on('check.complete', function() {
      t.editor.setProgressState(0);
    });
    t.spellchecker.on('select.word', function(e) {
      return tinymce.dom.Event.cancel(e);
    });
    t.spellchecker.on('replace.word', function() {
      if (t.spellchecker.parser.incorrectWords.length === 0) {
        t._onCheck(button);
      }
    });
  }

  positionSuggestBox = function() {

    var t = this;

    return function() {

      var dom = t.editor.dom;
      var vp = dom.getViewPort(t.editor.getWin());
      var word = (this.wordElement.data('firstElement') || this.wordElement)[0];

      var p1 = jq$(t.editor.getContentAreaContainer()).offset();
      var offset_top = p1.top;
      var offset_left = p1.left;

      var p2 = jq$(word).offset();
      var left = p2.left + offset_left;
      var top = p2.top - vp.y + offset_top + word.offsetHeight;

      this.container.css({ 
        top: top, 
        left: left 
      });
    };
  }
});
